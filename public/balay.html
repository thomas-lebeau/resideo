<!DOCTYPE html>
<style>
  input:invalid {
    border: 1px solid red;
  }
</style>

<body>
  <form id="form">
    <label>
      apikey:
      <input id="apikey" onblur="setUrlParam(this)" required>
    </label>
    <label>
      secret:
      <input id="secret" onblur="setUrlParam(this)" required>
    </label>
    <button type="button" id="btnAuth" onclick="auth()" disabled>login with balay</button>
    <label>
      code:
      <input id="code" readonly>
    </label>
    <button type="button" id="btnGetToken" onclick="getToken()" disabled>get Token</button>
    <label>
      token:
      <input id="token" readonly>
    </label>
    <label>
      refresh token:
      <input id="refresh_token" readonly>
    </label>
  </form>

  <script>
    const getUrlParam = (name) => new URL(window.location.href).searchParams.get(name)
    const setUrlParam = (input) => {
      const url = new URL(window.location.href)
      url.searchParams.set(input.id, input.value)

      window.location.href = url
    }
    const auth = () => {
      const url = new URL('https://api.home-connect.com/security/oauth/authorize')
      url.searchParams.set('response_type', 'code')
      url.searchParams.set('client_id', apikey.value)
      url.searchParams.set('scope', ['IdentifyAppliance', 'Monitor', 'Control', 'Images', 'Settings'].join('%20'))
      url.searchParams.set('redirect_uri', window.location.origin + window.location.pathname)
      url.searchParams.set('state', JSON.stringify({
        apikey: apikey.value,
        secret: secret.value
      }))

      window.location.href = url
    }

    const getToken = () => {
      const url = new URL('https://api.home-connect.com/security/oauth/token')
      url.searchParams.set('grant_type', 'authorization_code')
      url.searchParams.set('code', code.value)
      url.searchParams.set('client_id', apikey.value)
      url.searchParams.set('client_secret', secret.value)
      url.searchParams.set('redirect_uri', window.location.origin + window.location.pathname)

      window.location.href = url
    }

    // handle response from login
    if (getUrlParam('state')) {
      const { apikey, secret } = JSON.parse(getUrlParam('state'))
      const code = getUrlParam('code')

      const url = new URL(window.location.href)
      url.searchParams.set('apikey', apikey)
      url.searchParams.set('secret', secret)
      url.searchParams.set('code', code)
      url.searchParams.delete('state')

      window.location.href = url
    }

    apikey.value = getUrlParam('apikey')
    secret.value = getUrlParam('secret')
    code.value = getUrlParam('code')
    token.value = getUrlParam('access_token')
    refresh_token.value = getUrlParam('refresh_token')

    // enable get code button if we don't have a code
    if (apikey.value && secret.value && !code.value) {
      btnAuth.disabled = false
    }

    // enable login button if we're not logged in
    if (apikey.value && secret.value && code.value) {
      btnGetToken.disabled = false
    }

  </script>
</body>
